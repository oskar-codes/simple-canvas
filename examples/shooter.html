<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Canvas Shooter Example</title>
    <style>
      html,body {
        overflow: hidden;
        margin: 0;
        background-color: #200;
      }
      canvas {
        position: absolute;
        top: 0px;
        left: 0px;
      }
    </style>
  </head>
  <body>
    <canvas></canvas>
    <script src="../simple-canvas.js"></script>
    <script>
      var canvas = document.querySelector("canvas");
      var context = canvas.getContext("2d");

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      setupCanvas(context);

      function init() {
        preventcontextmenu();
        cursor("crosshair");

        window.x = canvas.width / 2;
        window.y = canvas.height / 2;
        window.dx = 0;
        window.dy = 0;
        window.spd = 4;
        window.f = 0.80
        window.canshoot = true;
        window.shootTimer = 0;
        window.score = 0;
        window.health = 100;
        window.isDead = false;
        window.endY = -canvas.height;
        window.endCol = 24;

        window.enemies = [];
        window.bullets = [];
        window.spawnDelay = 1800;

        window.shake = 0;
        window.backgroundColor = "#200";

        (function loop() {
          var spawns = [[
            Math.random() * canvas.width,
            -100
          ],
          [
            -100,
            Math.random() * canvas.height
          ],
          [
            canvas.width + 100,
            Math.random() * canvas.height
          ],
          [
            Math.random() * canvas.width,
            canvas.height + 100
          ]];
          var sizes = [150,100,75,50];
          var spawn = spawns[Math.floor(Math.random() * 4)];
          enemies.push({
            x: spawn[0],
            y: spawn[1],
            s: sizes[Math.floor(Math.random() * 4)],
            h: 3
          });

          spawnDelay *= 0.975;
          spawnDelay = Math.max(spawnDelay,400);

          setTimeout(loop, spawnDelay);
        })();
      }

      function update(deltaTime) {
        window.fps = 1 / (deltaTime / 1000);

        if (btn("W")) dy -= spd;
        if (btn("A")) dx -= spd;
        if (btn("S")) dy += spd;
        if (btn("D")) dx += spd;

        dx *= f;
        dy *= f;

        if (!isDead) {
          x += dx;
          y += dy;
        }

        x = clamp(x,0,canvas.width - 40);
        y = clamp(y,0,canvas.height - 40);

        if (!canshoot) {
          shootTimer += 1;
          if (shootTimer >= fps / 7) {
            canshoot = true;
            shootTimer = 0;
          }
        }
        if (mousedown() && canshoot && !isDead) {
          canshoot = false;
          var bulletDx = mouse()[0] - x;
          var bulletDy = mouse()[1] - y;

          var norm = Math.sqrt(bulletDx**2 + bulletDy**2);

          bulletDx /= norm;
          bulletDy /= norm;

          bullets.push({
            x: x + 25,
            y: y + 25,
            dx: bulletDx * 40,
            dy: bulletDy * 40
          });

          shake += 0.06;
        }

        cls(backgroundColor);
        backgroundColor = "#200";

        context.textAlign = "center";
        context.textBaseline = "middle";
        text(score,canvas.width / 2, canvas.height / 2, "#3d0000", canvas.height);

        health += 0.1;
        health = clamp(health,0,100);
        rectfill(canvas.width / 2 - 200, canvas.height - 100, 400, 60, "#8b0000");
        rectfill(canvas.width / 2 - 190, canvas.height - 90, (health / 100) * 380, 40, "#b00");
        rectfill(canvas.width / 2 - 190, canvas.height - 90, (health / 100) * 380, 30, "#f00");

        for (var i=0; i<enemies.length; i++) {
          var e = enemies[i];

          if (e.isHit) {
            if (e.s / 2 > 25) {
              for (var z=-1; z<=1; z+=2) {
                enemies.push({
                  x: e.x - 20 * z,
                  y: e.y,
                  s: e.s / 2,
                  h: 1
                })
              }
            }
            enemies.splice(i,1);
            if (!isDead) {
              score += 1;
              shake += 0.7
            }
          }

          var edx = (x - e.s / 4) - e.x;
          var edy = (y - e.s / 4) - e.y;

          var norm = Math.sqrt(edx**2 + edy**2);

          edx /= norm;
          edy /= norm;

          if (!isDead) {
            e.x += edx * 5;
            e.y += edy * 5;
          }

          var isHit = false;
          for (var a=0; a<bullets.length; a++) {
            var b = bullets[a];
            if (b.x + 7 > e.x &&
            b.x - 7 < e.x + e.s &&
            b.y + 7 > e.y &&
            b.y - 7 < e.y + e.s) {
              isHit = true;
              e.h -= 1;
              if (e.h <= 0) {
                e.isHit = true;
                backgroundColor = "#c00"
              }
            }
          }

          if (x + 30 > e.x &&
            x < e.x + e.s &&
            y + 30 > e.y &&
            y < e.y + e.s) {
              health -= 2;
              if (health <= 0 && !isDead) {
                isDead = true;
                shake += 1;
                if (!localStorage.getItem("highscore") || score > parseInt(localStorage.getItem("highscore"))) {
                  localStorage.setItem("highscore",score);
                }
              }
            }

          rectfill(e.x,e.y,e.s,e.s+10,isHit ? "white" : "darkred");
          rectfill(e.x,e.y,e.s,e.s,isHit ? "white" : "red");
        }

        for (var i=0; i<bullets.length; i++) {
          var b = bullets[i];

          if (!isDead) {
            b.x += b.dx;
            b.y += b.dy;
          }

          if (b.x < -10 || b.x > canvas.width + 10 || b.y < -10 || b.y > canvas.height + 10) bullets.splice(i, 1);

          circfill(b.x,b.y+7,15,"darkred");
          circfill(b.x,b.y,15,"red");
        }

        rectfill(x,y,30 + Math.abs(dx), 40 + Math.abs(dy),"darkred");
        rectfill(x,y,30 + Math.abs(dx), 30 + Math.abs(dy),"red");

        updateShake();

        if (isDead) {
          endY = lerp(endY,0,0.2);
          rectfill(0,endY,canvas.width,canvas.height,"#180000");

          if (endY > -10) {
            endCol += 1;
            endCol = clamp(endCol,24,255);
            context.textAlign = "center";
            context.textBaseline = "middle";
            text("Game Over", canvas.width / 2, canvas.height / 2, `rgb(${endCol},0,0)`, 169);
            text("Score: " + score + " Highscore: " + localStorage.getItem("highscore"), canvas.width / 2, canvas.height / 2 + 100, `rgb(${endCol},0,0)`, 40);
            text("Press anywhere to play again", canvas.width / 2, canvas.height / 2 + 150, `rgb(${endCol},0,0)`, 40);

            if (mousedown() && canRestart) {
              window.location.reload();
            }
          }

        }
        window.canRestart = !mousedown();
      }

      function updateShake() {
        shake = Math.min(shake,2);

        var shakex = 13 - Math.random() * 26;
        var shakey = 13 - Math.random() * 26;

        shakex *= shake;
        shakey *= shake;

        canvas.style.left = shakex + "px";
        canvas.style.top = shakey + "px";

        shake *= 0.95;
        if (shake<0.05) {
          shake = 0;
        }
      }

      function clamp(val,min,max) {
        return Math.min(Math.max(val,min),max)
      }
      function lerp(start, end, t) {
        return start * (1 - t) + end * t;
      }
    </script>
  </body>
</html>
